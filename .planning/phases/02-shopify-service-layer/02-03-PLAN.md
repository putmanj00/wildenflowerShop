---
phase: 02-shopify-service-layer
plan: 03
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - package.json
  - scripts/test-shopify.ts
autonomous: false
requirements:
  - SHOP-01
  - SHOP-03
  - SHOP-04
  - SHOP-05
user_setup:
  - service: shopify
    why: "Storefront API credentials are required to run the smoke test against the live Shopify store"
    env_vars:
      - name: EXPO_PUBLIC_SHOPIFY_STORE_DOMAIN
        source: "Shopify Admin → Settings → Domains (use your .myshopify.com domain)"
      - name: EXPO_PUBLIC_SHOPIFY_STOREFRONT_ACCESS_TOKEN
        source: "Shopify Admin → Apps and sales channels → Develop apps → [Your app] → API credentials → Storefront API access token (public token)"
    dashboard_config:
      - task: "Create a Storefront API private app (if not done already)"
        location: "Shopify Admin → Apps and sales channels → Develop apps → Create an app → Configure Storefront API scopes: unauthenticated_read_product_listings, unauthenticated_read_product_inventory, unauthenticated_read_collection_listings, unauthenticated_read_content, unauthenticated_read_checkouts"

must_haves:
  truths:
    - "npx tsx scripts/test-shopify.ts exits with code 0 when real credentials are in .env.local"
    - "Smoke test output shows first product from getProducts with title, handle, and price visible"
    - "Smoke test output shows all available Shopify collection handles alongside the app's expected handles — mismatches are explicitly flagged"
    - "Smoke test output shows first search result from searchProducts with a test query"
    - "Human has confirmed real Shopify data is returned (not mocked, not undefined, not error)"
    - "Collection handle mismatches (if any) are documented as a blocker in STATE.md before Phase 5"
  artifacts:
    - path: "scripts/test-shopify.ts"
      provides: "Permanent smoke test — verifies Shopify connection, prints data shapes, validates collection handles"
      min_lines: 60
    - path: "package.json"
      provides: "tsx and dotenv added as devDependencies"
      contains: "tsx"
  key_links:
    - from: "scripts/test-shopify.ts"
      to: "lib/shopify-client.ts"
      via: "import of getProducts, getCollections, searchProducts, getProductByHandle"
      pattern: "import.*from.*lib/shopify-client"
    - from: "scripts/test-shopify.ts"
      to: ".env.local"
      via: "dotenv config({ path: '.env.local' }) loading EXPO_PUBLIC_ vars before any service calls"
      pattern: "dotenv|config.*env.local"
---

<objective>
Install devDependencies for the smoke test, create the permanent smoke test script, and run human verification against the live Shopify store.

Purpose: The service layer exists on paper (Plans 01 and 02) but must be validated against a real Shopify store before any screen work begins. This plan closes the loop: real credentials, real data, real handles printed side-by-side so mismatches are spotted now rather than in Phase 5.

Output: scripts/test-shopify.ts (permanent, run with npx tsx), human confirmation that live data is returned, and any collection handle mismatches documented.
</objective>

<execution_context>
@/Users/jamesputman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesputman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-shopify-service-layer/02-CONTEXT.md
@.planning/phases/02-shopify-service-layer/02-RESEARCH.md
@.planning/phases/02-shopify-service-layer/02-01-SUMMARY.md
@.planning/phases/02-shopify-service-layer/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tsx + dotenv devDependencies and create smoke test script</name>
  <files>package.json, scripts/test-shopify.ts</files>
  <action>
Step 1 — Install devDependencies:
```bash
npm install --save-dev tsx dotenv
```

`tsx` runs TypeScript directly in Node without config (handles Expo's tsconfig).
`dotenv` loads .env.local so EXPO_PUBLIC_ vars are available outside the Metro bundler.

Step 2 — Create `scripts/` directory and `scripts/test-shopify.ts`:

```typescript
// scripts/test-shopify.ts
// Smoke test for the Shopify service layer.
// Run with: npx tsx scripts/test-shopify.ts
//
// Purpose: Verify credentials, data shapes, and collection handle alignment.
// Keep this script permanently — it's useful for onboarding and env var debugging.

// Load .env.local BEFORE any imports that read process.env
// (Metro bundler inlines EXPO_PUBLIC_ vars; Node does not — dotenv bridges the gap)
import { config } from 'dotenv';
config({ path: '.env.local' });

// Import service functions AFTER dotenv loads env vars
import { getProducts, getProductByHandle, getCollections, searchProducts } from '../lib/shopify-client';

// The category handles the Wildenflower app uses for Browse screen filtering.
// These must exist as collection handles in Shopify — update this list as the app evolves.
const APP_EXPECTED_HANDLES = ['earth', 'woven', 'light', 'crafted'];

async function main() {
  console.log('='.repeat(60));
  console.log('Wildenflower — Shopify Service Layer Smoke Test');
  console.log('='.repeat(60));
  console.log('');

  // ── 1. getProducts ──────────────────────────────────────────
  console.log('1. getProducts({ first: 3 })');
  console.log('-'.repeat(40));
  try {
    const result = await getProducts({ first: 3 });
    console.log(`  Total returned: ${result.items.length}`);
    console.log(`  hasNextPage: ${result.pageInfo.hasNextPage}`);
    if (result.items.length > 0) {
      const p = result.items[0];
      console.log('  First product:');
      console.log(`    id:      ${p.id}`);
      console.log(`    title:   ${p.title}`);
      console.log(`    handle:  ${p.handle}`);
      console.log(`    vendor:  ${p.vendor}`);
      console.log(`    price:   ${p.priceRange.minVariantPrice.amount} ${p.priceRange.minVariantPrice.currencyCode}`);
      console.log(`    images:  ${p.images.length} image(s)`);
      console.log(`    variants: ${p.variants.length} variant(s)`);
    } else {
      console.warn('  WARNING: No products returned. Check store has published products.');
    }
  } catch (err) {
    console.error('  ERROR:', err);
  }
  console.log('');

  // ── 2. getProductByHandle ───────────────────────────────────
  console.log('2. getProductByHandle (first product handle from above)');
  console.log('-'.repeat(40));
  try {
    const listResult = await getProducts({ first: 1 });
    if (listResult.items.length > 0) {
      const handle = listResult.items[0].handle;
      const product = await getProductByHandle(handle);
      console.log(`  Handle tested: "${handle}"`);
      console.log(`  Found: ${product ? 'YES' : 'NO — null returned'}`);
      if (product) {
        console.log(`  descriptionHtml present: ${!!product.descriptionHtml}`);
        console.log(`  tags: [${product.tags.join(', ')}]`);
      }
    } else {
      console.warn('  SKIPPED — no products available to test handle lookup');
    }
  } catch (err) {
    console.error('  ERROR:', err);
  }
  console.log('');

  // ── 3. getCollections ───────────────────────────────────────
  console.log('3. getCollections({ first: 20 }) — handle alignment check');
  console.log('-'.repeat(40));
  let shopifyHandles: string[] = [];
  try {
    const result = await getCollections({ first: 20 });
    shopifyHandles = result.items.map((c) => c.handle);
    console.log(`  Total collections: ${result.items.length}`);
    console.log(`  Available handles in Shopify:`);
    result.items.forEach((c) => console.log(`    - ${c.handle}  ("${c.title}")`));
    console.log('');
    console.log(`  App expects these handles: [${APP_EXPECTED_HANDLES.join(', ')}]`);
    const mismatches = APP_EXPECTED_HANDLES.filter((h) => !shopifyHandles.includes(h));
    const extras = shopifyHandles.filter((h) => !APP_EXPECTED_HANDLES.includes(h));
    if (mismatches.length === 0) {
      console.log('  HANDLE CHECK: PASS — all expected handles exist in Shopify');
    } else {
      console.warn(`  HANDLE CHECK: FAIL — missing from Shopify: [${mismatches.join(', ')}]`);
      console.warn('  ACTION REQUIRED: Either add these collections to Shopify or update APP_EXPECTED_HANDLES');
      console.warn('  Document mismatches in STATE.md as a blocker before Phase 5 screen work begins.');
    }
    if (extras.length > 0) {
      console.log(`  Extra Shopify handles not in app expectations: [${extras.join(', ')}]`);
    }
  } catch (err) {
    console.error('  ERROR:', err);
  }
  console.log('');

  // ── 4. searchProducts ───────────────────────────────────────
  console.log('4. searchProducts("handmade", { first: 3 })');
  console.log('-'.repeat(40));
  try {
    const result = await searchProducts('handmade', { first: 3 });
    console.log(`  Total matching: ${result.totalCount}`);
    console.log(`  Returned: ${result.items.length}`);
    if (result.items.length > 0) {
      console.log('  First result:');
      console.log(`    title:  ${result.items[0].title}`);
      console.log(`    handle: ${result.items[0].handle}`);
      console.log(`    vendor: ${result.items[0].vendor}`);
    } else {
      console.warn('  No results for "handmade" — try a different test query for your store');
    }
  } catch (err) {
    console.error('  ERROR:', err);
  }

  console.log('');
  console.log('='.repeat(60));
  console.log('Smoke test complete.');
  console.log('Run again anytime: npx tsx scripts/test-shopify.ts');
  console.log('='.repeat(60));
}

main().catch((err) => {
  console.error('Smoke test failed with unhandled error:', err);
  process.exit(1);
});
```

Step 3 — Verify TypeScript compiles after install:
```bash
npx tsc --noEmit 2>&1 | head -20
```

Fix any TypeScript errors before proceeding to the verification checkpoint.

Note: The smoke test imports use relative paths (`../lib/shopify-client`) because `scripts/` is one level below the root. If tsx has trouble with path resolution, try running from the project root: `npx tsx scripts/test-shopify.ts`.
  </action>
  <verify>
- devDependencies installed: `cat package.json | grep -E '"tsx"|"dotenv"'`
- Script exists: `ls scripts/test-shopify.ts`
- TypeScript compiles: `npx tsc --noEmit 2>&1 | head -20` — zero errors
- tsx can parse the file: `npx tsx --version && echo "tsx available"`
  </verify>
  <done>tsx and dotenv installed as devDependencies. scripts/test-shopify.ts created with all four service function tests and handle alignment check. TypeScript compiles with zero errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human smoke test verification against live Shopify store</name>
  <files>scripts/test-shopify.ts</files>
  <action>Run `npx tsx scripts/test-shopify.ts` after populating .env.local with real Shopify credentials. Confirm real product data, collection handles, and search results appear in the output with no ERROR lines.</action>
  <verify>npx tsx scripts/test-shopify.ts exits 0 with real product data printed</verify>
  <done>Human confirms live Shopify data returned; collection handle alignment check completed; any mismatches noted.</done>
  <what-built>
Complete Shopify service layer (Plans 01-03):
- .env.local with EXPO_PUBLIC_ credential placeholders
- types/shopify.ts with all Shopify raw API type definitions
- lib/shopify-queries.ts with 5 GraphQL query strings and fragments
- lib/shopify-client.ts with ShopifyError, shopifyFetch, and 5 service functions
- lib/shopify-mappers.ts with pure transformation functions
- scripts/test-shopify.ts permanent smoke test script

To run the smoke test, you must first populate .env.local with real Shopify credentials.
  </what-built>
  <how-to-verify>
Step 1 — Set credentials in .env.local:
Open .env.local and replace the placeholder values with your actual Shopify store domain and Storefront access token.
- EXPO_PUBLIC_SHOPIFY_STORE_DOMAIN → your actual .myshopify.com domain (e.g., wildenflower.myshopify.com)
- EXPO_PUBLIC_SHOPIFY_STOREFRONT_ACCESS_TOKEN → your public Storefront API access token

Step 2 — Run the smoke test:
```
npx tsx scripts/test-shopify.ts
```

Step 3 — Verify the output:
a) getProducts section shows at least 1 product with a real title, handle, vendor, and price (not undefined)
b) getProductByHandle section shows "Found: YES" for the handle tested
c) getCollections section shows the available Shopify collection handles
d) HANDLE CHECK line shows either PASS or FAIL with the mismatch list
e) searchProducts section shows results (or a "no results" warning to try a different query)
f) No "ERROR:" lines in the output (connection errors, 401 Unauthorized, etc.)

Step 4 — If HANDLE CHECK shows FAIL:
Note which handles are missing. This is NOT a blocker for Phase 2 completion — it's a warning for Phase 5. The smoke test surfacing the mismatch is the correct behavior.

Step 5 — Confirm output looks like real Shopify data (not mock data, not undefined values).
  </how-to-verify>
  <resume-signal>
Type "approved" if the smoke test ran successfully and real Shopify data appeared in the output.
If there were errors, describe what failed (e.g., "401 Unauthorized", "connection refused", "undefined store domain") so fixes can be applied.
If collection handle mismatches were found, list them here so they can be documented in STATE.md.
  </resume-signal>
</task>

</tasks>

<verification>
Final phase verification after human approval:
1. `npx tsc --noEmit 2>&1` — zero errors
2. `ls lib/shopify-queries.ts lib/shopify-client.ts lib/shopify-mappers.ts types/shopify.ts scripts/test-shopify.ts` — all 5 files exist
3. `cat package.json | grep -E '"tsx"|"dotenv"'` — both devDependencies present
4. `git status --short .env.local` — .env.local is gitignored (not tracked)
5. Human confirmed real Shopify data returned in smoke test output
</verification>

<success_criteria>
- scripts/test-shopify.ts runs successfully with real Shopify credentials: `npx tsx scripts/test-shopify.ts`
- Output shows real product data (title, handle, vendor, price — not undefined)
- Collection handles printed side-by-side with app expected handles
- Any handle mismatches explicitly flagged (PASS or FAIL clearly indicated)
- Zero TypeScript errors across the project
- Human has confirmed data is real and service layer is functional
- Phase 2 goal achieved: live Shopify data accessible from any file in the app
</success_criteria>

<output>
After completion, create `.planning/phases/02-shopify-service-layer/02-03-SUMMARY.md`
</output>
