---
phase: 07-cart-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(tabs)/cart.tsx
autonomous: true
requirements: [COMM-04]

must_haves:
  truths:
    - "Cart screen renders all Shopify cart line items with thumbnail, product title, variant title, quantity stepper, and line price on one row"
    - "The minus '−' stepper button is disabled (not hidden) when line quantity = 1; tapping the '×' button removes the line"
    - "Tapping '+' calls updateQuantity(lineId, qty + 1); tapping '×' calls removeFromCart(lineId)"
    - "Order summary section shows subtotal from cart.cost.subtotalAmount and a 'Shipping & taxes calculated at checkout' note"
    - "Gold 'Proceed to Checkout' button calls openCheckout(); button is disabled when cart is null or has no lines"
    - "Empty cart shows botanical placeholder View + 'Nothing here yet — but the best things take time.' copy + 'Start Discovering' button that navigates to Browse tab"
    - "Loading state (isLoading = true) shows ActivityIndicator centered on parchment screen"
    - "Cart screen renders without layout errors on Expo Web"
  artifacts:
    - path: "app/(tabs)/cart.tsx"
      provides: "Complete Cart screen: line item list, qty stepper, order summary, checkout button, empty state"
      min_lines: 220
  key_links:
    - from: "cart.tsx CartLineRow"
      to: "CartContext.updateQuantity / removeFromCart"
      via: "useCart() hook"
      pattern: "useCart"
    - from: "cart.tsx Checkout button"
      to: "CartContext.openCheckout"
      via: "openCheckout()"
      pattern: "openCheckout"
    - from: "cart.tsx 'Start Discovering' button"
      to: "app/(tabs)/browse.tsx"
      via: "router.push('/(tabs)/browse')"
      pattern: "router.push"
---

<objective>
Build the Cart screen — the final UI step before Shopify checkout. Replaces the 10-line stub in app/(tabs)/cart.tsx with a complete, brand-faithful implementation using live CartContext data.

Purpose: Completes COMM-04 — a finder can review their cart, adjust quantities, remove items, see the subtotal, and proceed to Shopify checkout.
Output: Complete app/(tabs)/cart.tsx (≥ 220 lines)
</objective>

<execution_context>
@/Users/jamesputman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesputman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@context/CartContext.tsx
@types/shopify.ts
@constants/theme.ts
@components/layout/Screen.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CartLineRow sub-component (inline, not exported)</name>
  <files>app/(tabs)/cart.tsx</files>
  <action>
Define a `CartLineRow` function component at the top of the file (above `CartScreen`, not exported). It renders one `ShopifyCartLine` as a single row.

**Props:**
```typescript
interface CartLineRowProps {
  line: ShopifyCartLine;
  onRemove: (lineId: string) => void;
  onDecrement: (lineId: string, currentQty: number) => void;
  onIncrement: (lineId: string, currentQty: number) => void;
  disabled: boolean; // true during any in-flight mutation
}
```

**Row layout (flexDirection: 'row', alignItems: 'center'):**

1. **Thumbnail** — `Image` from `line.merchandise.product.featuredImage?.url`. Size: 72×72, borderRadius: spacing.sm, resizeMode: 'cover'. If `featuredImage` is null, show a `View` with backgroundColor: colors.parchmentDark at the same size (ASSET: product-placeholder-thumb.png).

2. **Text column** (flex:1, marginHorizontal: spacing.sm):
   - Product title: `line.merchandise.product.title` — fontFamily: fonts.heading, fontSize: fontSizes.body, color: colors.terracotta
   - Variant title: `line.merchandise.title` — fontFamily: fonts.body, fontSize: fontSizes.caption, color: colors.sage
   - Line price: `$${parseFloat(line.cost.totalAmount.amount).toFixed(2)}` — fontFamily: fonts.heading, fontSize: fontSizes.body, color: colors.gold, marginTop: spacing.xs

3. **Controls column** (alignItems: 'center', gap: spacing.xs):
   - **"×" remove button**: TouchableOpacity, onPress → `onRemove(line.id)`, disabled by `disabled` prop. Style: paddingHorizontal: spacing.xs, paddingBottom: spacing.xs. Text: '×', fontFamily: fonts.body, fontSize: 18, color: colors.earth, opacity: 0.5.
   - **Stepper row** (flexDirection: 'row', alignItems: 'center', borderWidth:1, borderColor: colors.border, borderRadius: spacing.round (999)):
     - '−' button: TouchableOpacity, onPress → `onDecrement(line.id, line.quantity)`, **disabled when `line.quantity <= 1` OR `disabled` prop is true**. Style: paddingHorizontal: spacing.sm, paddingVertical: spacing.xs. Render at opacity 0.3 when disabled. Text: '−', fontFamily: fonts.heading, fontSize: fontSizes.body, color: colors.earth.
     - Quantity: Text `{line.quantity}`, fontFamily: fonts.heading, fontSize: fontSizes.body, color: colors.earth, minWidth: 24, textAlign: 'center'.
     - '+' button: TouchableOpacity, onPress → `onIncrement(line.id, line.quantity)`, disabled by `disabled` prop. Text: '+', same style as '−' button.

**Separator:** `BotanicalDivider variant="minimal"` (or if that variant doesn't exist, a plain View with height:1, backgroundColor: colors.border, marginVertical: spacing.md) between rows.

**DO NOT** make CartLineRow a separate file — keep it in cart.tsx. This avoids unnecessary import overhead for a screen-specific sub-component.

**AVOID** using `isRemovingFromCart` or `isUpdatingQuantity` individually — instead pass `isLoading` from CartContext as the `disabled` prop to block ALL controls during any in-flight mutation. This prevents double-taps during concurrent operations.
  </action>
  <verify>`npx tsc --noEmit` — zero errors on the CartLineRow component definition.</verify>
  <done>CartLineRow renders thumbnail, title, variant, price, × button, and stepper with '−' disabled at qty=1. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Build CartScreen with list, order summary, empty state, and checkout button</name>
  <files>app/(tabs)/cart.tsx</files>
  <action>
Replace the stub `CartScreen` with the full implementation. Use `Screen` (not ScrollScreen) — the sticky checkout bar must live outside the scroll area.

**Imports:**
```typescript
import React from 'react';
import {
  View, Text, Image, ScrollView, TouchableOpacity,
  StyleSheet, ActivityIndicator,
} from 'react-native';
import { useRouter } from 'expo-router';
import { colors, fonts, fontSizes, spacing } from '../../constants/theme';
import { useCart } from '../../context/CartContext';
import type { ShopifyCartLine } from '../../types/shopify';
import Screen from '../../components/layout/Screen';
import BotanicalDivider from '../../components/BotanicalDivider';
```

**Hook destructuring:**
```typescript
const { cart, isLoading, removeFromCart, updateQuantity, openCheckout, cartTotal } = useCart();
const router = useRouter();
const lines = cart?.lines.nodes ?? [];
```

**Mutation handlers (define inside CartScreen):**
```typescript
function handleRemove(lineId: string) {
  removeFromCart(lineId);
}
function handleDecrement(lineId: string, currentQty: number) {
  if (currentQty <= 1) return; // button is disabled, but guard anyway
  updateQuantity(lineId, currentQty - 1);
}
function handleIncrement(lineId: string, currentQty: number) {
  updateQuantity(lineId, currentQty + 1);
}
```

**Loading state:** If `isLoading && !cart`:
```tsx
<Screen>
  <View style={styles.centered}>
    <ActivityIndicator size="large" color={colors.terracotta} />
  </View>
</Screen>
```

**Empty state** (when `lines.length === 0` and not loading):
```tsx
<Screen>
  <View style={styles.emptyContainer}>
    {/* ASSET: empty-cart-botanical.png — Watercolor botanical illustration: trailing vines with small wildflowers */}
    <View style={styles.emptyIllustration} />
    <Text style={styles.emptyHeading}>Nothing here yet</Text>
    <Text style={styles.emptySubtext}>
      But the best things take time.
    </Text>
    <TouchableOpacity
      style={styles.discoverButton}
      onPress={() => router.push('/(tabs)/browse')}
    >
      <Text style={styles.discoverButtonText}>Start Discovering</Text>
    </TouchableOpacity>
  </View>
</Screen>
```

**Populated cart layout:**
```
<Screen>
  {/* Scrollable line items */}
  <ScrollView style={styles.scroll} contentContainerStyle={styles.scrollContent}>
    <Text style={styles.screenTitle}>Your Cart</Text>
    <BotanicalDivider variant="fern" />
    {lines.map((line) => (
      <CartLineRow
        key={line.id}
        line={line}
        onRemove={handleRemove}
        onDecrement={handleDecrement}
        onIncrement={handleIncrement}
        disabled={isLoading}
      />
    ))}
    <View style={{ height: spacing.xl }} />
  </ScrollView>

  {/* Sticky order summary + checkout button */}
  <View style={styles.summaryBar}>
    <View style={styles.summaryRow}>
      <Text style={styles.summaryLabel}>Subtotal</Text>
      <Text style={styles.summaryValue}>${cartTotal.toFixed(2)}</Text>
    </View>
    <Text style={styles.shippingNote}>
      Shipping & taxes calculated at checkout
    </Text>
    <TouchableOpacity
      style={[styles.checkoutButton, (!cart || lines.length === 0) && styles.checkoutButtonDisabled]}
      onPress={openCheckout}
      disabled={!cart || lines.length === 0}
    >
      <Text style={styles.checkoutButtonText}>Proceed to Checkout</Text>
    </TouchableOpacity>
    <Text style={styles.checkoutCaption}>You're about to make someone's day.</Text>
  </View>
</Screen>
```

**Key styles (use theme tokens only — no hardcoded values):**
- `scroll`: flex: 1
- `scrollContent`: paddingHorizontal: spacing.screenPadding, paddingTop: spacing.lg
- `screenTitle`: fontFamily: fonts.heading, fontSize: fontSizes.h2, color: colors.terracotta, marginBottom: spacing.sm
- `centered`: flex: 1, justifyContent: 'center', alignItems: 'center'
- `emptyContainer`: flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: spacing.screenPadding, gap: spacing.md
- `emptyIllustration`: width: 200, height: 200, backgroundColor: colors.parchmentDark, borderRadius: spacing.md
- `emptyHeading`: fontFamily: fonts.heading, fontSize: fontSizes.h2, color: colors.terracotta, textAlign: 'center'
- `emptySubtext`: fontFamily: fonts.accent, fontSize: fontSizes.body, color: colors.sage, textAlign: 'center', fontStyle: 'italic'
- `discoverButton`: backgroundColor: colors.gold, borderRadius: spacing.round (999), paddingHorizontal: spacing.xl, paddingVertical: spacing.sm, marginTop: spacing.sm
- `discoverButtonText`: fontFamily: fonts.heading, fontSize: fontSizes.button, color: colors.earth
- `summaryBar`: borderTopWidth: 1, borderTopColor: colors.border, backgroundColor: colors.parchment, paddingHorizontal: spacing.screenPadding, paddingTop: spacing.md, paddingBottom: spacing.lg
- `summaryRow`: flexDirection: 'row', justifyContent: 'space-between', marginBottom: spacing.xs
- `summaryLabel`: fontFamily: fonts.body, fontSize: fontSizes.body, color: colors.earth
- `summaryValue`: fontFamily: fonts.heading, fontSize: fontSizes.body, color: colors.earth
- `shippingNote`: fontFamily: fonts.body, fontSize: fontSizes.caption, color: colors.sage, marginBottom: spacing.md
- `checkoutButton`: backgroundColor: colors.gold, borderRadius: spacing.round (999), paddingVertical: spacing.md, alignItems: 'center', marginBottom: spacing.xs
- `checkoutButtonDisabled`: opacity: 0.5
- `checkoutButtonText`: fontFamily: fonts.heading, fontSize: fontSizes.button, color: colors.earth
- `checkoutCaption`: fontFamily: fonts.accent, fontSize: fontSizes.caption, color: colors.sage, textAlign: 'center', fontStyle: 'italic'

**AVOID** rendering the sticky summary bar when in empty or loading state — it should only appear when `lines.length > 0`.

**AVOID** using `cart.cost.totalAmount` for the displayed subtotal — use `cartTotal` (pre-computed from `cart.cost.subtotalAmount` in CartContext). Total may include taxes depending on Shopify store config; subtotal is the correct pre-checkout figure.

**Check BotanicalDivider variants first** — if `variant="fern"` doesn't exist, use whichever variant the component supports (check components/BotanicalDivider.tsx). Do not invent new variants.
  </action>
  <verify>
1. `npx tsc --noEmit` — zero errors
2. Start expo web: `npx expo start --web` and open localhost in browser
3. Navigate to Cart tab — empty state shows illustration placeholder + copy + "Start Discovering" button; tapping it navigates to Browse
4. Add a product to cart from Browse or Product Detail, return to Cart tab — line item row renders with thumbnail, title, variant, stepper, price
5. Tap '+' → quantity increments; item price updates
6. Tap '−' at qty=2 → decrements to 1; '−' button becomes visually disabled at qty=1 and cannot be tapped
7. Tap '×' → item removed from cart; empty state appears
8. Subtotal matches Shopify cart subtotalAmount; "Shipping & taxes..." note present
9. "Proceed to Checkout" button visible; tapping it navigates to Shopify checkout URL
  </verify>
  <done>CartScreen fully implemented: line item list with CartLineRow, order summary with subtotal + shipping note, gold checkout button, empty state with CTA. Zero TypeScript errors. COMM-04 complete.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` zero errors
- Empty cart: illustration placeholder + "Nothing here yet — but the best things take time." + "Start Discovering" button
- "Start Discovering" navigates to Browse tab
- Populated cart: thumbnail, product title, variant title, qty stepper, line price per row
- '−' disabled (opacity 0.3, not tappable) at qty=1; '+' and '×' always enabled
- '×' removes the line item; cart updates without full page reload
- Sticky summary bar: subtotal (from `cartTotal`) + "Shipping & taxes calculated at checkout" note
- Gold "Proceed to Checkout" button calls `openCheckout()`
- Checkout button disabled when cart is empty
- "You're about to make someone's day." caption below checkout button
- Screen renders without layout breakage on Expo Web
</verification>

<success_criteria>
Cart screen complete with all COMM-04 requirements: Shopify cart line items displayed correctly, quantity controls call correct mutations, order summary from live Shopify data, checkout opens `cart.checkoutUrl`, empty state is navigable. Zero TypeScript errors.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cart-checkout/07-01-SUMMARY.md`
</output>
